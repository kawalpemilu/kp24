<table class="collapsed_border">
    @for (c of lokasi.children; track c.id) {
    <tr *ngIf="c.agg[0] as a">
        @if (lokasi.id + c.id; as tpsId) {
        <td width="145" align="center" nowrap valign="top"
            [style.background-color]="a.totalPendingTps ? 'orange' : ''">
            <br>
            <b style="font-size: large">TPS #{{ a.name }}</b>
            <br>
            <br>
            Pas1: <b>{{ a.pas1 }}</b><br>
            Pas2: <b>{{ a.pas2 }}</b><br>
            Pas3: <b>{{ a.pas3 }}</b><br>
            <br>
            DPT: <b>{{ a.dpt }}</b><br>
            <br>
            @if (service.currentUserProfile && service.currentUserProfile.role >= USER_ROLE.MODERATOR) {
                <button *ngIf="a.totalPendingTps"
                    (click)="isUploadDrawer[tpsId] = false; isDrawerOpen[tpsId] = !drawer.opened; drawer.toggle()"
                    mat-raised-button color="accent">Review ({{ numPendingUploads(a) }})</button>
            }
        </td>
        <td width="*" align="left">
            <mat-drawer-container [hasBackdrop]="true">
                <mat-drawer #drawer mode="over" (openedChange)="isDrawerOpen[tpsId] = $event">
                @defer (on viewport) {
                    @if (isUploadDrawer[tpsId]) {
                        <app-upload [id]="tpsId"
                            (onUpload)="onUpload(c, $event); isDrawerOpen[tpsId] = false; drawer.close()">
                        </app-upload>
                    } @else if (service.currentUserProfile && service.currentUserProfile.role >= USER_ROLE.MODERATOR) {
                        <app-review [id]="tpsId"
                            (onReview)="onChange.emit(); isDrawerOpen[tpsId] = false; drawer.close()">
                        </app-review>
                    }
                } @placeholder { 
                    <br>
                }
                </mat-drawer>
                <mat-drawer-content>
                    <div style="min-width: 300px; overflow-x: scroll"
                        [style.width]="(service.viewportWidth - 150) + 'px'">
                    <table [style.height]="isDrawerOpen[tpsId] ? '500px' : '250px'">
                    <tr>
                        <td>
                            <div (click)="isUploadDrawer[tpsId] = true; isDrawerOpen[tpsId] = !drawer.opened; drawer.toggle()"
                                    style="width: 100px; text-align: center; cursor: pointer;">
                                <button mat-fab color="primary">
                                    <mat-icon>add_a_photo</mat-icon>
                                </button>
                                <p style="margin-top: 10px;">
                                    <b>Upload<br>Photo</b>
                                </p>
                            </div>
                        </td>
            @if (service.currentUserProfile?.uploads; as uploads) {
                @if (uploads[tpsId]; as u) {
                    @for (u of c.userUploads; track u.imageId) {
                        <td valign="top">
                            <app-photo [uploadRequest]="u"></app-photo>
                            @if (u.status === APPROVAL_STATUS.NEW) {
                                Pending Review
                            } @else if (u.status === APPROVAL_STATUS.REJECTED) {
                                Rejected
                            }
                        </td>
                    }
                }
            }
            @if (c.agg.length > 1) {
                @for (tps of c.agg.slice(1); track tps.uploadedPhoto?.imageId) {
                <td valign="top">
                    <app-photo [aggregatedVotes]="tps"></app-photo>
                    @if (tps.status === APPROVAL_STATUS.NEW) {
                        Uploading
                    }
                </td>
                }
            }
                    </tr>
                    </table>
                    </div>
                </mat-drawer-content>
            </mat-drawer-container>
        </td>
        }
    </tr>
}
</table>
